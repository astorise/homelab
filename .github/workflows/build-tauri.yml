name: Build Tauri

on:
  push:
    branches-ignore: ['codex/*']
  workflow_dispatch:

jobs:
  build-docker-image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - run: docker build -t env-dev-image -f docker-image/Dockerfile .
      - run: |
          cid=$(docker create env-dev-image)
          docker export "$cid" -o env-dev-image.tar
          docker rm "$cid"
      - uses: actions/upload-artifact@v5
        with:
          name: env-dev-image.tar
          path: env-dev-image.tar
  build-services:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache Rust (workspace)
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: services-x86_64-pc-windows-msvc
          cache-on-failure: true

      - name: Build services (Windows MSVC)
        shell: pwsh
        run: |
          cargo build -p home-dns   --release
          cargo build -p home-http --release
          cargo build -p home-oidc --release
          Get-ChildItem target/release -Filter 'home-*.exe'
          New-Item -ItemType Directory -Path services-win -Force | Out-Null
          Copy-Item target/release/home-dns.exe   services-win/ -Force
          Copy-Item target/release/home-http.exe  services-win/ -Force
          Copy-Item target/release/home-oidc.exe services-win/ -Force

      - name: Upload services artifacts
        uses: actions/upload-artifact@v5
        with:
          name: services-win
          path: services-win/*

  # === OPTION RECOMMANDÃ‰E: installateur Windows officiel (runner Windows) ===
  build-tauri-win:
    runs-on: windows-latest
    needs: [build-services, build-docker-image]
    steps:
      - uses: actions/checkout@v6

      - name: Clear bundled services directory
        shell: pwsh
        run: |
          $bin = 'home-lab/src-tauri/resources/bin'
          if (Test-Path $bin) {
            Get-ChildItem $bin -Filter '*.exe' -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue
          } else {
            New-Item -ItemType Directory -Path $bin | Out-Null
          }

      - name: Download services artifacts into resources/bin
        uses: actions/download-artifact@v6
        with:
          name: services-win
          path: home-lab/src-tauri/resources/bin

      - name: Download Docker image into Tauri WSL resources
        uses: actions/download-artifact@v6
        with:
          name: env-dev-image.tar
          path: home-lab/src-tauri/resources/wsl

      - name: Rename Docker image artifact to WSL rootfs
        shell: pwsh
        run: |
          Move-Item -LiteralPath 'home-lab/src-tauri/resources/wsl/env-dev-image.tar' `
                    -Destination 'home-lab/src-tauri/resources/wsl/wsl-rootfs.tar' `
                    -Force

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
      
      - name: import windows certificate
        if: matrix.platform == 'windows-latest'
        env:
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERT_PASSWORD }}
        run: |
          New-Item -ItemType directory -Path certificate
          Set-Content -Path certificate/tempCert.txt -Value $env:WINDOWS_CERTIFICATE
          certutil -decode certificate/tempCert.txt certificate/certificate.pfx
          Remove-Item -path certificate -include tempCert.txt
          Import-PfxCertificate -FilePath certificate/certificate.pfx -CertStoreLocation Cert:\CurrentUser\My -Password (ConvertTo-SecureString -String $env:WINDOWS_CERTIFICATE_PASSWORD -Force -AsPlainText)
      - name: Install frontend deps + Tauri CLI
        working-directory: home-lab
        shell: pwsh
        run: |
          if (Test-Path package-lock.json) { npm ci } else { npm install }
          $hasCli = (npm pkg get devDependencies.'@tauri-apps/cli' | Select-String -Quiet '@tauri-apps/cli')
          if (-not $hasCli) { npm i -D @tauri-apps/cli@latest }
          npx tauri -V

      # Optionnel : cache npm
      - name: Enable npm cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('home-lab/**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Build Tauri (Windows - NSIS + MSI)
        uses: tauri-apps/tauri-action@v0.6.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_BUNDLE_DEBUG: "true"
          TAURI_BUNDLE_TARGETS: "nsis,msi"
        with:
          projectPath: ./home-lab

      - name: Upload NSIS setup
        uses: actions/upload-artifact@v5
        with:
          name: nsis-setup
          path: target/release/bundle/nsis/*.exe
          if-no-files-found: error

      - name: Upload MSI package
        uses: actions/upload-artifact@v5
        with:
          name: msi-package
          path: target/release/bundle/msi/*.msi
          if-no-files-found: error
