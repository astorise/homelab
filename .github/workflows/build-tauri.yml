name: Build Tauri

on:
  push:
    branches-ignore: ['codex/*']
  workflow_dispatch:

jobs:
  build-docker-image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - run: docker build -t env-dev-image -f docker-image/Dockerfile .
      - run: |
          cid=$(docker create env-dev-image)
          docker export "$cid" -o env-dev-image.tar
          docker rm "$cid"
      - uses: actions/upload-artifact@v4
        with:
          name: env-dev-image.tar
          path: env-dev-image.tar
  build-services:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Install mingw for Windows cross-compile
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-gnu

      - name: Cache Rust (workspace)
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: services-x86_64-pc-windows-gnu
          cache-on-failure: true

      - name: Build services (Windows gnu)
        env:
          RUSTFLAGS: "-C target-feature=+crt-static"
        run: |
          cargo build -p home-dns   --release --target x86_64-pc-windows-gnu
          cargo build -p home-http --release --target x86_64-pc-windows-gnu
          ls -lah target/x86_64-pc-windows-gnu/release
          mkdir -p services-win
          cp target/x86_64-pc-windows-gnu/release/home-dns.exe   services-win/
          cp target/x86_64-pc-windows-gnu/release/home-http.exe services-win/

      - name: Upload services artifacts
        uses: actions/upload-artifact@v4
        with:
          name: services-win
          path: services-win/*

  # === OPTION RECOMMANDÃ‰E: installateur Windows officiel (runner Windows) ===
  build-tauri-win:
    runs-on: windows-latest
    needs: [build-services, build-docker-image]
    env:
      WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
      WINDOWS_CERT_PASSWORD: ${{ secrets.WINDOWS_CERT_PASSWORD }}
    steps:
      - uses: actions/checkout@v5

      - name: Download services artifacts into Tauri resources/bin
        uses: actions/download-artifact@v5
        with:
          name: services-win
          path: home-lab/src-tauri/resources/bin

      - name: Download Docker image into Tauri resources
        uses: actions/download-artifact@v5
        with:
          name: env-dev-image.tar
          path: home-lab/src-tauri/resources

      - name: Rename Docker image
        run: mv home-lab/src-tauri/resources/env-dev-image.tar home-lab/src-tauri/resources/homelab-img.tar

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22'

      - name: Install frontend deps + Tauri CLI
        working-directory: home-lab
        shell: pwsh
        run: |
          if (Test-Path package-lock.json) { npm ci } else { npm install }
          $hasCli = (npm pkg get devDependencies.'@tauri-apps/cli' | Select-String -Quiet '@tauri-apps/cli')
          if (-not $hasCli) { npm i -D @tauri-apps/cli@latest }
          npx tauri -V

      - name: import windows certificate
        env:
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERT_PASSWORD }}
        run: |
          New-Item -ItemType directory -Path certificate
          Set-Content -Path certificate/tempCert.txt -Value $env:WINDOWS_CERTIFICATE
          certutil -decode certificate/tempCert.txt certificate/certificate.pfx
          Remove-Item -path certificate -include tempCert.txt
          Import-PfxCertificate -FilePath certificate/certificate.pfx -CertStoreLocation Cert:\CurrentUser\My -Password (ConvertTo-SecureString -String $env:WINDOWS_CERTIFICATE_PASSWORD -Force -AsPlainText)
        # Optionnel : cache npm

      - name: Enable npm cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('home-lab/**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Build Tauri (Windows - NSIS + MSI)
        id: tauri_build
        uses: tauri-apps/tauri-action@v0.5.23
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_BUNDLE_DEBUG: "false"
        with:
          projectPath: ./home-lab
          args: -b nsis,msi

      - name: Debug Tauri artifacts
        shell: pwsh
        run: |
          Write-Host 'artifactPaths from tauri-action:'
          Write-Host "${{ steps.tauri_build.outputs.artifactPaths }}"
          Write-Host 'Listing bundle directories:'
          Get-ChildItem -Path 'home-lab' -Recurse -Directory -Filter bundle | ForEach-Object { $_.FullName }

      - name: Sign MSI package (post-bundle)
        if: ${{ env.WINDOWS_CERTIFICATE != '' && env.WINDOWS_CERT_PASSWORD != '' }}
        shell: pwsh
        run: |
          $artifactRaw = '${{ steps.tauri_build.outputs.artifactPaths }}'
          if ($artifactRaw.Trim().StartsWith('[')) {
            $artifacts = $artifactRaw | ConvertFrom-Json
          } else {
            $artifacts = $artifactRaw -split "`r?`n|;"
          }
          $artifacts = @($artifacts) | Where-Object { $_ -and $_.Trim() -ne '' }
          $msiPath = $artifacts | Where-Object { $_ -match '\.msi$' } | Select-Object -First 1
          if (-not $msiPath) {
            Write-Warning 'No MSI found in tauri-action outputs; skipping MSI signing.'
            exit 0
          }
          & "$env:SIGNTOOL" sign /fd SHA256 /f "$env:SIGN_PFX_PATH" /p "$env:WINDOWS_CERT_PASSWORD" /tr http://timestamp.digicert.com /td SHA256 $msiPath

      - name: Sign NSIS setup (post-bundle)
        if: ${{ env.WINDOWS_CERTIFICATE != '' && env.WINDOWS_CERT_PASSWORD != '' }}
        shell: pwsh
        run: |
          $artifactRaw = '${{ steps.tauri_build.outputs.artifactPaths }}'
          if ($artifactRaw.Trim().StartsWith('[')) {
            $artifacts = $artifactRaw | ConvertFrom-Json
          } else {
            $artifacts = $artifactRaw -split "`r?`n|;"
          }
          $artifacts = @($artifacts) | Where-Object { $_ -and $_.Trim() -ne '' }
          $exePath = $artifacts | Where-Object { $_ -match '\.(?i)exe$' -and $_ -like '*\bundle\nsis\*' } | Select-Object -First 1
          if (-not $exePath) { Write-Host 'No NSIS executable found to sign.'; exit 0 }
          & "$env:SIGNTOOL" sign /fd SHA256 /f "$env:SIGN_PFX_PATH" /p "$env:WINDOWS_CERT_PASSWORD" /tr http://timestamp.digicert.com /td SHA256 $exePath

      - name: Upload MSI package
        uses: actions/upload-artifact@v4
        with:
          name: msi-package
          path: home-lab/**/bundle/msi/*.msi
          if-no-files-found: error

      - name: Upload NSIS setup
        uses: actions/upload-artifact@v4
        with:
          name: nsis-setup
          path: home-lab/**/bundle/nsis/*.exe
          if-no-files-found: warn

      # Note: only one MSI is produced and uploaded



